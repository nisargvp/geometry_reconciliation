---
title: "The geometry of forecast reconciliation"
author: "Rob J Hyndman"
date: 28 August 2020
fontsize: 14pt
titlefontsize: 32pt
classoption: aspectratio=169
toc: true
output:
  binb::monash:
    fig_height: 4.33
    fig_width: 7
    colortheme: monashwhite
    keep_tex: yes
    includes:
      in_header: header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, message = FALSE, warning = FALSE, cache = TRUE,
  dev.args = list(pointsize = 11)
)
options(digits = 3, width = 60)
library(fpp3)
```

# Hierarchical and grouped time series

## Australian Pharmaceutical Benefits Scheme

\full{pills}

## ATC drug classification
\fontsize{12}{13}\sf

\hspace*{-0.5cm}\begin{tabular}{lp{10.7cm}}
A &Alimentary tract and metabolism\\
B &Blood and blood forming organs\\
C &Cardiovascular system\\
D &Dermatologicals\\
G &Genito-urinary system and sex hormones\\
H &Systemic hormonal preparations, excluding sex hormones and insulins\\
J &Anti-infectives for systemic use\\
L &Antineoplastic and immunomodulating agents\\
M &Musculo-skeletal system\\
N &Nervous system\\
P &Antiparasitic products, insecticides and repellents\\
R &Respiratory system\\
S &Sensory organs\\
V &Various
\end{tabular}

## ATC drug classification
\hspace*{-1.5cm}\begin{minipage}{9.6cm}
\begin{tikzpicture}
\tikzstyle{every node}=[ellipse,font=\small,draw,fill=red!15]
\tikzstyle[level font=\small,set style={{every node}+=[fill=blue!15]}]
\tikzstyle{level 1}=[font=\small,set style={{every node}+=[fill=blue!15]}]
\tikzstyle{level 2}=[font=\small,set style={{every node}+=[fill=yellow]}]
\node[label=right:\hspace*{-0.cm}Alimentary tract and metabolism,label=left:\textbf{ATC1: 14 classes}\hspace*{0.3cm}]{A}[edge from parent fork down]
   child {node[label=right:\hspace*{-0.0cm}Drugs used in diabetes,label=left:\textbf{ATC2: 84 classes}]{A10}
     child {node[label=right:\hspace*{-0.35cm}Blood glucose lowering drugs]{A10B}
       child {node[label=right:\hspace*{0.1cm}Biguanides]{A10BA}
         child {node[label=right:\hspace*{-0.15cm}Metformin]{A10BA02}
 }}}};
 \end{tikzpicture}
\end{minipage}

## PBS sales
\fontsize{9}{10}\sf

```{r pbs, echo=FALSE}
PBS %>%
  group_by(ATC1,ATC2) %>%
  summarise(
    Scripts = sum(Scripts),
    Cost = sum(Cost)
  ) %>%
  ungroup() %>%
  select(Month, ATC1, ATC2, Scripts, Cost)
```


## Australian tourism
\placefig{0}{1.4}{width=9cm}{regions1_with_labels}

\only<2>{\begin{textblock}{7.7}(8,1.4)\fontsize{12}{13}\sf
\begin{block}{}
  \begin{itemize}\itemsep=0cm\parskip=0cm
    \item Quarterly data on visitor night from 1998:Q1 -- 2013:Q4
    \item From \textit{National Visitor Survey}, annual interviews of 120,000 Australians aged 15+.
    \item Split by 7 states, 27 zones and 76 regions (a geographical hierarchy)
    \item Also split by purpose of travel
      \begin{itemize}\itemsep=0cm\parskip=0cm
        \item Holiday
        \item Visiting friends and relatives (VFR)
        \item Business
        \item Other
      \end{itemize}
    \item 304 bottom-level series
  \end{itemize}
\end{block}
\end{textblock}}

## Australian tourism
\fontsize{11}{12}\sf

```{r tourism}
tourism
```


## Hierarchical time series
\fontsize{13}{14}\sf

A \alert{\textbf{hierarchical time series}} is a collection of several time series that are linked together in a hierarchical structure.

\begin{minipage}{9.6cm}
\begin{block}{}
\begin{tikzpicture}
\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,fill=red!15]
\tikzstyle[level distance=.1cm]
\tikzstyle[sibling distance=7cm]
\tikzstyle{level 1}=[sibling distance=33mm,set style={{every node}+=[fill=blue!15]}]
\tikzstyle{level 2}=[sibling distance=10mm,font=\small,set style={{every node}+=[fill=yellow]}]
\node{Total}[edge from parent fork down]
 child {node {A}
   child {node {AA}}
   child {node {AB}}
   child {node {AC}}
 }
 child {node {B}
   child {node {BA}}
   child {node {BB}}
   child {node {BC}}
 }
 child {node {C}
   child {node {CA}}
   child {node {CB}}
   child {node {CC}}
 };
\end{tikzpicture}
\end{block}
\end{minipage}

\pause\alert{Examples}\vspace*{-0.2cm}

 * PBS sales by ATC groups
 * Tourism demand by states, zones, regions

## Grouped time series
\fontsize{13}{14}\sf

A \alert{\textbf{grouped time series}} is a collection of time series that can be grouped together in a number of non-hierarchical ways.

\begin{minipage}{9.2cm}
\begin{block}{}
\begin{tikzpicture}[level distance=1.5cm]
\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,outer sep=0pt, fill=red!15]
\tikzstyle{level 1}=[sibling distance=23mm,set style={{every node}+=[fill=blue!15]},level distance=1cm]
\tikzstyle{level 2}=[sibling distance=10mm,font=\small,set style={{every node}+=[fill=yellow]}, level distance=0.9cm]
\node{Total}[edge from parent fork down]
 child {node {A}
   child {node {AX}}
   child {node {AY}}
 }
 child {node {B}
   child {node {BX}}
   child {node {BY}}
 };
\end{tikzpicture}\hspace*{1cm}
\begin{tikzpicture}[level distance=1.5cm]
\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,outer sep=0pt, fill=red!15]
\tikzstyle{level 1}=[sibling distance=23mm,set style={{every node}+=[fill=blue!15]},level distance=1cm]
\tikzstyle{level 2}=[sibling distance=10mm,font=\small,set style={{every node}+=[fill=yellow]}, level distance=0.9cm]
\node{Total}[edge from parent fork down]
 child {node {X}
   child {node {AX}}
   child {node {BX}}
 }
 child {node {Y}
   child {node {AY}}
   child {node {BY}}
 };
\end{tikzpicture}
\end{block}
\end{minipage}

\pause\alert{Examples}

 * Tourism by state and purpose of travel
 * Retail sales by product groups/sub groups, and by countries/regions

# Forecast reconciliation

## The problem
\fontsize{13}{14}\sf
\begin{alertblock}{}
How to produce \textbf{coherent} forecasts at all nodes?
\end{alertblock}\pause

### Old approaches (pre 2009)

  * Bottom-up forecasting
  * Top-down forecasting
  * Middle-out forecasting

\pause

### Forecast reconcilation approach

1. Forecast all series at all levels of aggregation using an automatic forecasting algorithm.  (e.g., `ETS`, `ARIMA`, ...)
2. Reconcile the resulting forecasts so they are coherent using least squares optimization (i.e., find closest reconciled forecasts to the original forecasts).

## Key forecast reconciliation papers
\fontsize{12}{14}\sf

* Hyndman, Ahmed, Athanasopoulos, Shang (2011 \emph{CSDA}) Optimal combination forecasts for hierarchical time series.
* Athanasopoulos, Ahmed, Hyndman (2009 \emph{IJF}) Hierarchical forecasts for Australian domestic tourism.
* Hyndman, Lee, Wang (2016 \emph{CSDA}) Fast computation of reconciled forecasts for hierarchical and grouped time series.
* Wickramasuriya, Athanasopoulos, Hyndman (2019 \emph{JASA}) Optimal forecast reconciliation for hierarchical and grouped time series through trace minimization.
* Panagiotelis, Gamakumara, Athanasopoulos, Hyndman (2020 \emph{IJF}) Forecast reconciliation: A geometric view with new insights on bias correction.
* Panagiotelis, Gamakumara, Athanasopoulos, Hyndman (2020) Probabilistic forecast reconciliation: properties, evaluation and score optimisation.


## Hierarchical and grouped time series

\begin{textblock}{8.5}(0.2,1.5)
Every collection of time series with linear constraints can be written as
\centerline{\colorbox[RGB]{210,210,210}{$\bY_{t}=\color{blue}\bS\color{red}\bm{b}_{t}$}}
\vspace*{-0.9cm}\begin{itemize}\parskip=0cm\itemsep=0cm
\item $\by_t=$ vector of all series at time $t$
\item $ y_{t}= $ aggregate of all series at time
$t$.
\item $ y_{X,t}= $ value of series $X$ at time $t$.
\item $\color{red}{\bm{b}_t}=$ vector of most disaggregated series at time $t$
\item $\color{blue}{\bS}=$ ``summing matrix'' containing the linear constraints.
\end{itemize}
\end{textblock}

\begin{textblock}{5.7}(11.4,0.1)
\begin{minipage}{4cm}
\begin{block}{}\centering
\begin{tikzpicture}
\tikzstyle{every node}=[ellipse,draw,fill=red!15,inner sep=2pt]
\tikzstyle[level distance=.3cm]
\tikzstyle[sibling distance=12cm]
\tikzstyle{level 1}=[sibling distance=10mm,font=\small,set style={{every node}+=[fill=blue!15]}]
\node{Total}[edge from parent fork down]
 child {node {A}
 }
 child {node {B}
 }
 child {node {C}
 };
\end{tikzpicture}
\end{block}
\end{minipage}
\end{textblock}

\begin{textblock}{5.7}(9.4,2.9)\fontsize{14}{15}\sf
\begin{align*}
\bY_{t}&= \begin{pmatrix}
  y_{t}\\
  y_{A,t}\\
  y_{B,t}\\
  y_{C,t}
  \end{pmatrix}  \\
  &= {\color{blue}\underbrace{\begin{pmatrix}
                1 & 1 & 1 \\
                1 & 0 & 0 \\
                0 & 1 & 0\\
                0 & 0 & 1
                \end{pmatrix}}_{\bS}}
     {\color{red}\underbrace{\begin{pmatrix}
       y_{A,t}\\y_{B,t}\\y_{C,t}
       \end{pmatrix}}_{\bm{b}_{t}}}
\end{align*}
\end{textblock}

\vspace*{10cm}


## Hierarchical time series

\begin{block}{}\hspace*{.6cm}{\centering\small
\begin{tikzpicture}[level distance=1cm]
\tikzstyle{every node}=[ellipse,draw,fill=red!15,inner sep=2pt]
\tikzstyle[level distance=.01cm]
\tikzstyle[sibling distance=12cm]
\tikzstyle{level 2}=[sibling distance=10mm,font=\scriptsize,set style={{every node}+=[fill=yellow]}]
\tikzstyle{level 1}=[sibling distance=40mm,font=\footnotesize,set style={{every node}+=[fill=blue!15]}]
\node{Total}[edge from parent fork down]
 child {node {A}
   child {node {AX}}
   child {node {AY}}
   child {node {AZ}}
 }
 child {node {B}
   child {node {BX}}
   child {node {BY}}
   child {node {BZ}}
 }
 child {node {C}
   child {node {CX}}
   child {node {CY}}
   child {node {CZ}}
 };
\end{tikzpicture}}
\end{block}\vspace*{0.1cm}\pause\fontsize{8}{8}\sf

\hbox{$\by_{t}= \begin{pmatrix}
    y_t\\
    y_{A,t}\\
    y_{B,t}\\
    y_{C,t}\\
    y_{AX,t}\\
    y_{AY,t}\\
    y_{AZ,t}\\
    y_{BX,t}\\
    y_{BY,t}\\
    y_{BZ,t}\\
    y_{CX,t}\\
    y_{CY,t}\\
    y_{CZ,t}\end{pmatrix}=
    {\color{red}{\begin{pmatrix}
                1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\
                1 & 1 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
                0 & 0 & 0 & 1 & 1 & 1 & 0 & 0 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 1 & 1 & 1\\
                1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
                0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
                0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
                0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0\\
                0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0\\
                0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1\\
             \end{pmatrix}}}{\color{blue}{\begin{pmatrix}
    y_{AX,t}\\
    y_{AY,t}\\
    y_{AZ,t}\\
    y_{BX,t}\\
    y_{BY,t}\\
    y_{BZ,t}\\
    y_{CX,t}\\
    y_{CY,t}\\
    y_{CZ,t}\end{pmatrix}}}$}

    \vspace*{10cm}

\only<3>{\begin{textblock}{3}(10.5,8)\fontsize{14}{15}\sf\colorbox[gray]{.8}{$\by_{t}=\color{red}\bS\color{blue}\bm{b}_{t}$}\end{textblock}}


## Grouped data

\begin{block}{}
\begin{center}\small
\tikzstyle{every node}=[inner sep=2pt]
\begin{tikzpicture}
    \matrix[ampersand replacement=\&,column sep=0.3cm] {
        \node[ellipse,draw,fill=yellow,font=\scriptsize,distance=1cm] {AX};~ \&
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {AY};~ \&
        \node[ellipse,draw,fill=blue!15] {A}; \\[0.3cm]
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {BX};~ \&
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {BY};~ \&
        \node[ellipse,draw,fill=blue!15] {B}; \\[0.3cm]
        \node[ellipse,draw,fill=blue!15] {X};~ \&
        \node[ellipse,draw,fill=blue!15] {Y};~ \&
        \node[ellipse,draw,fill=red!15] {Total}; \\
};
\end{tikzpicture}
\end{center}
\end{block}\pause\fontsize{10}{11}\sf


\hbox{$\by_{t}= \begin{pmatrix}
    y_t\\
    y_{A,t}\\
    y_{B,t}\\
    y_{X,t}\\
    y_{Y,t}\\
    y_{AX,t}\\
    y_{AY,t}\\
    y_{BX,t}\\
    y_{BY,t}
    \end{pmatrix}=
    \color{red}\begin{pmatrix}
                1 & 1 & 1 & 1 \\
                1 & 1 & 0 & 0 \\
                0 & 0 & 1 & 1 \\
                1 & 0 & 1 & 0 \\
                0 & 1 & 0 & 1 \\
                1 & 0 & 0 & 0 \\
                0 & 1 & 0 & 0 \\
                0 & 0 & 1 & 0 \\
                0 & 0 & 0 & 1
             \end{pmatrix}
    \color{blue}\begin{pmatrix}
    y_{AX,t}\\
    y_{AY,t}\\
    y_{BX,t}\\
    y_{BY,t}
    \end{pmatrix}$}

\vspace*{-1cm}

\only<3>{\begin{textblock}{3}(10.5,8)\fontsize{14}{15}\sf\colorbox[gray]{.8}{$\by_{t}=\color{red}\bS\color{blue}\bm{b}_{t}$}\end{textblock}}

\vspace*{10cm}

## Definitions

\begin{textblock}{9}(.2,1.25)\fontsize{13}{14}\sf
\begin{block}{Coherent subspace}
$m$-dimensional linear subspace $\mathfrak{s}\subset \mathbb{R}^n$ for which linear constraints hold for all $\bm{y}\in\mathfrak{s}$.
\end{block}\vspace*{-0.25cm}
\begin{block}{Hierarchical time series}
An $n$-dimensional multivariate time series such that $\bm{y}_t\in\mathfrak{s}\quad\forall t$.
\end{block}\vspace*{-0.25cm}
\begin{block}{Coherent point forecasts}
$\tilde{\bm{y}}_{t+h|t}$ is \emph{coherent} if $\tilde{\bm{y}}_{t+h|t} \in \mathfrak{s}$.
\end{block}\vspace*{-0.2cm}
\end{textblock}
\only<2-3>{\begin{textblock}{7.5}(.2,6.6)
\begin{alertblock}{Base forecasts}
Let $\hat{\bm{y}}_{t+h|t}$ be vector of \emph{incoherent} initial $h$-step forecasts.$\phantom{y_{t|h}}$
\end{alertblock}
\end{textblock}}
\only<3>{\begin{textblock}{7.5}(8.3,6.6)
\begin{alertblock}{Reconciled forecasts}
Let $\psi$ be a mapping, $\psi:\mathbb{R}^n\rightarrow\mathfrak{s}$.  $\tilde{\bm{y}}_{t+h|t}=\psi(\hat{\bm{y}}_{t+h|t})$ ``reconciles'' $\hat{\bm{y}}_{t+h|t}$.
\end{alertblock}
\end{textblock}}

\placefig{9.4}{.0}{width=6.6cm}{3D_hierarchy}
\begin{textblock}{3}(11.4,5.6)
\begin{block}{}
\centerline{$ y_{Tot} = y_A + y_B$}
\end{block}
\end{textblock}

## Linear reconciliation

\begin{textblock}{9}(0.2,1.3)\fontsize{13}{14}\sf
\begin{block}{}
If $\psi$ is a linear function and $\bm{G}$ is some matrix, then
$$\tilde{\bm{y}}_{t+h|t}=\bm{S}\bm{G}\hat{\bm{y}}_{t+h|t}$$
\end{block}\vspace*{-0.3cm}
\begin{itemize}
\item $\bm{G}$ extracts and combines base forecasts $\hat{\by}_{T+h|T}$ to get bottom-level forecasts.
\item $\bS$ creates linear combinations.
\end{itemize}
\end{textblock}

\only<2->{
  \begin{textblock}{9}(0.2,5.4)
  \begin{block}{}
  e.g., OLS reconciliation: $\bm{G} = (\bm{S}'\bm{S})^{-1}\bm{S}'$
  \end{block}
  \end{textblock}
}
\only<2->{
\placefig{9.4}{-0.5}{width=6.6cm}{fig3}
}

\only<3>{
  \begin{textblock}{9}(0.2,6.3)
  \begin{alertblock}{Projections}
  Suppose $\bm{S}\bm{G}$ is a projection onto $\mathfrak{s}$, then\fontsize{12}{13}\sf
  \begin{itemize}
  \item Coherent base forecasts are unchanged.
  \item Unbiased base forecasts remain unbiased.
  \end{itemize}
  \end{alertblock}
  \end{textblock}
}
\only<3>{
  \begin{textblock}{6.6}(9.2,5.5)\fontsize{12}{12}\sf
  \begin{itemize}
  \item Orthogonal projections lead to smallest possible adjustments of base forecasts.
  \end{itemize}
  \end{textblock}
}

\only<4>{
  \begin{textblock}{9}(0.2,6.3)
  \begin{alertblock}{Distance reducing property}
  If $\bm{S}\bm{G}$ is an orthogonal projection onto $\mathfrak{s}$ then:
  \begin{equation*}
    \|\bm{y}_{t+h}-\tilde{\bm{y}}_{t+h|t}\|\le\|\bm{y}_{t+h}-\hat{\bm{y}}_{t+h|t}\|.
  \end{equation*}
  \end{alertblock}
  \end{textblock}
}

\only<4>{
  \begin{textblock}{6.6}(9.2,5.5)\fontsize{12}{12}\sf
  \begin{itemize}
  \item Distance reduction holds for any realisation and any forecast.
  \item Other measures of forecast accuracy may be worse.
  \item Not necessarily the optimal reconciliation.
  \end{itemize}
  \end{textblock}
}

## Oblique projections

\begin{textblock}{5}(6,0)
\begin{block}{}
\centerline{$\tilde{\by}_{T+h|T}=\bS\bm{G}\hat{\by}_{T+h|T}$}
\end{block}
\end{textblock}

\begin{textblock}{9}(0.2,1.25)\fontsize{13}{14}\sf
\begin{block}{Variance}
\centerline{$\bm{V}_h = \var[\by_{T+h} - \tilde{\by}_{T+h|T}  \mid \by_1,\dots,\by_n]  = \bS\bm{G}\bm{W}_{h}\bm{G}'\bS'$}
where $\bm{W}_h = \var[\by_{T+h} - \hat{\by}_{T+h|T} \mid \by_1,\dots,\by_n]$.
\end{block}\vspace*{-0.2cm}
\begin{alertblock}{Minimum trace (MinT) reconciliation}
If $\bm{S}\bm{G}$ is a projection, then the trace of $\bm{V}_h$ is minimized when
$$
  \bm{G} = (\bS'\bm{W}_h^{-1}\bS)^{-1}\bS'\bm{W}_h^{-1}{h}
$$
\end{alertblock}
\end{textblock}

\only<2>{\placefig{9.7}{1.5}{width=7.4cm}{InsampDir_1_George}}
\only<3>{\placefig{9.7}{1.5}{width=7.4cm}{InsampDir_2_George}}
\only<4>{\placefig{9.7}{1.5}{width=7.4cm}{OrthProj_George}}
\only<5>{\placefig{9.7}{1.5}{width=7.4cm}{ObliqProj_George}}

\only<2->{
  \begin{textblock}{9}(.7,6)
  \begin{itemize}\itemsep=0cm
  \item $R$ is the most likely direction of deviations from $\mathfrak{s}$.
  \only<2>{\item Orange: in-sample errors}
  \only<3->{\item Grey: potential base forecasts}
  \only<4->{\item Red: reconciled forecsts}
  \end{itemize}
  \end{textblock}
}

\only<4->{
  \begin{textblock}{5}(10,7.3)
  \begin{block}{}
  \only<4>{Orthogonal projection}
  \only<5>{Oblique projection}
  \end{block}
  \end{textblock}
}

## Linear projections

\begin{textblock}{9.2}(.5,1.2)
\begin{block}{}
\begin{tabular}{ll}
  \textbf{Reconciliation method} & $\bm{G}$ \\
  \midrule
  OLS             & $(\bm{S}'\bm{S})^{-1}\bm{S}'$ \\
  WLS             & $(\bm{S}'\bm{\Lambda}\bm{S})^{-1}\bm{S}'\bm{\Lambda}$ \\
  MinT(Sample)    & $(\bm{S}'\hat{\bm{W}}_{\text{sam}}^{-1}\bm{S})^{-1}\bm{S}' \hat{\bm{W}}_{\text{sam}}^{-1}$  \\
  MinT(Shrink)    & $(\bm{S}'\hat{\bm{W}}_{\text{shr}}^{-1}\bm{S})^{-1}\bm{S}' \hat{\bm{W}}_{\text{shr}}^{-1}$  \\
\end{tabular}
\end{block}
\end{textblock}
\begin{textblock}{14}(.2,5.3)\fontsize{13}{14}\sf
\begin{itemize}
\item $\bm{\Lambda}$ is diagonal matrix
\item $\hat{\bm{W}}_{\text{sam}}$ is sample estimate of the residual covariance matrix
\item $\hat{\bm{W}}_{\text{shr}}$ is shrinkage estimator $\tau \textrm{diag}(\hat{\bm{W}}_{\text{sam}})+(1-\tau)\hat{\bm{W}}_{\text{sam}}$ where $\tau = \displaystyle\frac{\sum_{i \neq j}\hat{\var}(\hat{\sigma}_{ij})}{\sum_{i \neq j}{\hat{\sigma}}^2_{ij}}$ and $\sigma_{ij}$ denotes the $(i,j)$th element of $\hat{\bm{W}}_{\text{sam}}$.
\end{itemize}
\end{textblock}

\begin{textblock}{5}(10.7,1.2)
\begin{alertblock}{}
These all assume that $\bm{W}_h = k_h \bm{W}_1$ to simplify computations.
\end{alertblock}
\end{textblock}

## To add from geometry paper

* Tourism example from geometry paper (not bias section)


# Example: Australian tourism

## Example: Australian tourism
\fontsize{12}{13}\sf

```{r fctourism}
tourism_agg <- tourism %>%
  aggregate_key(Purpose * (State / Region),
    Trips = sum(Trips)
  )
fc <- tourism_agg %>%
  filter(Quarter <= yearquarter("2015 Q4")) %>%
  model(ets = ETS(Trips)) %>%
  reconcile(ets_adjusted = min_trace(ets)) %>%
  forecast(h = "2 years")
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fctourism2, dependson='fctourism'}
fc %>%
  filter(is_aggregated(Purpose) & is_aggregated(State)) %>%
  autoplot(tourism_agg, level = 95)
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fctourism3, dependson='fctourism'}
fc %>%
  filter(is_aggregated(Purpose) & State == "Victoria" &
    is_aggregated(Region)) %>%
  autoplot(tourism_agg, level = 95)
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fctourism4, dependson='fctourism'}
fc %>%
  filter(is_aggregated(Purpose) & Region == "Melbourne") %>%
  autoplot(tourism_agg, level = 95)
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fctourism5, dependson='fctourism'}
fc %>%
  filter(is_aggregated(Purpose) & Region == "Snowy Mountains") %>%
  autoplot(tourism_agg, level = 95)
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fctourism6, dependson='fctourism'}
fc %>%
  filter(Purpose == "Holiday" & Region == "Barossa") %>%
  autoplot(tourism_agg, level = 95)
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fctourism7, dependson='fctourism'}
fc %>%
  filter(is_aggregated(Purpose) & Region == "MacDonnell") %>%
  autoplot(tourism_agg, level = 95)
```

## Example: Australian tourism
\fontsize{12}{12.5}\sf

```{r fctourismcomb}
fc <- tourism_agg %>%
  filter(Quarter <= yearquarter("2015 Q4")) %>%
  model(
    ets = ETS(Trips),
    arima = ARIMA(Trips)
  ) %>%
  mutate(
    comb = (ets + arima) / 2
  ) %>%
  reconcile(
    ets_adj = min_trace(ets),
    arima_adj = min_trace(arima),
    comb_adj = min_trace(comb)
  ) %>%
  forecast(h = "2 years")
```

## Forecast evaluation
\fontsize{10}{11}\sf

```{r fcaccuracy, dependson='fctourismcomb'}
fc %>% accuracy(tourism_agg)
```

## Forecast evaluation
\fontsize{12}{13}\sf

```{r fcaccuracy2, dependson='fctourismcomb'}
fc %>%
  accuracy(tourism_agg) %>%
  group_by(.model) %>%
  summarise(MASE = mean(MASE)) %>%
  arrange(MASE)
```

## Creating aggregates
\fontsize{7}{7}\sf

```{r pbs_aggregate}
PBS %>%
  aggregate_key(ATC1 / ATC2, Scripts = sum(Scripts)) %>%
  filter(Month == yearmonth("1991 Jul")) %>%
  print(n = 18)
```

## Creating aggregates
\fontsize{8}{8}\sf

```{r tourism_aggregate}
tourism %>%
  aggregate_key(Purpose * (State / Region), Trips = sum(Trips)) %>%
  filter(Quarter == yearquarter("1998 Q1")) %>%
  print(n = 15)
```

## Creating aggregates
\fontsize{13}{15}\sf

 * Similar to `summarise()` but using the key structure
 * A grouped structure is specified using `grp1 * grp2`
 * A nested structure is specified via `parent / child`.
 * Groups and nesting can be mixed:

    ```r
    (country/region/city) * (brand/product)
    ```

 * All possible aggregates are produced.
 * These are useful when forecasting at different levels of aggregation.


## Forecast reconciliation
\fontsize{9}{10}\sf

```{r tourismets_reconciled, message=FALSE}
tourism %>%
  aggregate_key(Purpose * (State / Region), Trips = sum(Trips)) %>%
  model(ets = ETS(Trips)) %>%
  reconcile(ets_adjusted = min_trace(ets)) %>%
  forecast(h = 2)
```

# Probabilistic forecast reconciliation

## Coherent probabilistic forecasts
\begin{textblock}{9.5}(0.2,1.2)\fontsize{13}{15}\sf
\begin{block}{Coherent probabilistic forecasts}
Given the triple $(\mathbb{R}^m, \mathscr{F}_{\mathbb{R}^m}, \nu)$, a coherent probability triple $(\mathfrak{s}, \mathscr{F}_{\mathfrak{s}}, \breve{\nu})$  is such that
$$
  \breve{\nu}(s(\mathcal{B})) = \nu(\mathcal{B}) \quad \forall \mathcal{B} \in \mathscr{F}_{\mathbb{R}^m}.
$$
\end{block}\vspace*{-0.2cm}
\begin{block}{Probabilistic forecast reconciliation}
The reconciled probability measure of $\hat{\nu}$ wrt $\psi(.)$ is such that
  \[
  \tilde{\nu}(\mathcal{B}) = \hat{\nu}(\psi^{-1}(\mathcal{B})) \qquad \forall \mathcal{B} \in \mathscr{F}_{\mathfrak{s}}\,,
  \]
  where $\psi^{-1}(\mathcal{B}):=\{{\bm{y}}\in \mathbb{R}^n:\psi({\bm{y}})\in \mathcal{B}\}$ is the pre-image of $\mathcal{B}$, that is the set of all points in $\mathbb{R}^n$ that $\psi(.)$ maps to a point in $\mathcal{B}$.
\end{block}
\end{textblock}
\begin{textblock}{7}(9.5,1.2)
\resizebox{\textwidth}{!}{
\input figs/probforerec_schematic.tex
}
\end{textblock}

## Construction of reconciled distributions

### Reconciled density of bottom-level

Density of bottom-level series under reconciled distribution is
\[
  \tilde{f}_{\bm{b}}(\bm{b})=|\bm{G}^*|\int \hat{f}(\bm{G}^{-}\bm{b}+\bm{G}_\perp \bm{a})d\bm{a}\,,
\]

  * $\hat{f}$ is density of incoherent base probabilistic forecast
  * $\bm{G^-}$ is $n\times m$ generalised inverse of $\bm{G}$ st $\bm{G}\bm{G}^-=\bm{I}$
  * $\bm{G_\perp}$ is $n\times (n-m)$ orthogonal complement to $\bm{G}$ st $\bm{G}\bm{G}_\perp=\bm{0}$
  * $\bm{G}^*=\left(\bm{G}^-\,\vdots\,\bm{G}_\perp\right)$, and $\bm{b}$ and $\bm{a}$ are obtained via\newline the change of variables $\bm{y}=\bm{G}^*\begin{pmatrix}\bm{b}\\\bm{a}\end{pmatrix}$

## Construction of reconciled distributions

### Reconciled density of full hierarchy

Density of full hierarchy under reconciled distribution is
\[
  \tilde{f}_{\bm{y}}(\bm{y}) =
  |\bm{S}^*| \tilde{f}_{\bm{b}}({\bm{S}^-\bm{y}})
  \mathbb{1}\{\bm{y}\in\mathfrak{s}\}\,,
\]

  * $\bm{S}^*=\begin{pmatrix}
  \bm{S}^-\\
  \bm{S}'_\perp
  \end{pmatrix}$
  * $\bm{S^-}$ is $m\times n$ generalised inverse of $\bm{S}$ such that $\bm{S}^-\bm{S}=\bm{I}$,
  * $\bm{S_\perp}$ is $n\times (n-m)$ orthogonal complement to $\bm{S}$ such that $\bm{S}'_\perp\bm{S}=\bm{0}$.


## To add from probabilistic paper

 * Theorem 3.5
 * Table 2
 * Score optimal reconciliation
 * Electricity example
